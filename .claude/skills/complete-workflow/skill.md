---
name: complete-workflow
description: "完整功能開發工作流程 - 代碼審查→代碼簡化與修正→知識管理→Git推送。階段一發現問題，階段二自動修正🔴高嚴重度問題並簡化代碼，最後自動 commit & push"
---

# Complete Workflow - 完整功能開發工作流程

功能開發完成後的標準化流程，確保代碼品質與知識沉澱。

---

## 工作流程

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  功能開發   │ -> │  代碼審查   │ -> │  代碼簡化   │ -> │  知識管理   │
│   完成      │    │  (review)   │    │ (simplify)  │    │ (knowledge)  │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                      │  ▲                                   │
                      │  │  發現問題                          │
                      │  └─── 需修正 ───┐                    │
                      │                  │                    v
                      │           ┌─────────────┐    ┌─────────────┐
                      │           │  自動修正   │    │ Git Commit  │
                      │           │  高嚴重度   │    │   & Push    │
                      │           │    問題     │    └─────────────┘
                      │           └─────────────┘
                      └─────────── 重新審查 ────┘
```

### 工作流程說明
1. **階段一 (review)**：代碼審查，識別所有問題
2. **階段二 (simplify)**：
   - **自動修正階段一發現的 🔴 高嚴重度問題**
   - 簡化代碼結構
   - 優化效能
3. **階段三 (knowledge)**：記錄修復過程與知識沉澱
4. **最終階段 (git)**：Commit & Push

---

## 階段一：代碼審查 (review)

### 目標
- 檢查程式碼品質
- 識別安全漏洞
- 確保最佳實踐

### 執行
```
/review
```

### 通過標準
- 🔴 高嚴重度問題：**0 個**
- 🟡 中嚴重度問題：**≤2 個**
- 🟢 低嚴重度問題：**≤5 個**
- 整體評分：**≥7/10**

### 輸出
| 項目 | 內容 |
|------|------|
| 嚴重度分布 | 🔴 X / 🟡 X / 🟢 X |
| 整體評分 | X/10 |
| 必須修復 | 問題列表 |
| 建議改善 | 優化建議 |

---

## 階段二：代碼簡化與修正 (simplify)

### 目標
- **自動修正階段一發現的 🔴 高嚴重度問題**
- 減少代碼重複
- 提升可讀性
- 優化效能

### 執行步驟

#### 步驟 1：修正高嚴重度問題
**必須先修正階段一發現的 🔴 高嚴重度問題才能繼續**

| 問題類型 | 修正方式 |
|---------|---------|
| 資料庫連線洩漏 | 加入 `db.close()` 或使用 context manager |
| 同步/異步混用 | 統一為異步或同步 |
| 敏感資訊洩漏 | 移除硬編碼憑證，使用環境變數 |
| SQL 注入風險 | 使用參數化查詢 |
| 未處理異常 | 加入 try-except 區塊 |

#### 步驟 2：代碼簡化
修正問題後，繼續簡化代碼結構：

| 簡化項目 | 說明 |
|---------|------|
| 移除重複代碼 | `get_or_create_user`、Token 重試邏輯等重複函數 |
| 拆分長函數 | `handle_text_message` (83行)、`process_elder_image` (124行) |
| 提取共用邏輯 | 加密、驗證、錯誤處理等 |
| 優化命名 | 變數、函數名稱清晰易懂 |

使用 `test-writer-fixer` agent 或手動重構。

### 檢查項目
- [ ] **🔴 高嚴重度問題已全部修正**
- [ ] 移除重複代碼
- [ ] 簡化複雜邏輯
- [ ] 提取共用函數
- [ ] 優化命名
- [ ] 減少嵌套層級

### 通過標準
- **🔴 高嚴重度問題：0 個**（必須滿足）
- 無明顯代碼重複
- 函數單一職責
- 命名清晰易懂

### 驗證機制
修正完成後，**重新執行 `/review`** 確認：
- 🔴 高嚴重度問題已修正為 0 個
- 整體評分 ≥ 7/10

若未達標準，繼續修正直到通過。

---

## 階段三：知識管理 (knowledge)

### 目標
- 記錄修復過程
- 沉澱經驗知識
- 建立問題模式庫

### 執行
```
/knowledge record
```

### 記錄內容
```markdown
## 問題描述
- 錯誤訊息: ...
- 發生場景: ...

## 根本原因
- 技術原因: ...
- 設計問題: ...

## 解決方案
- 修改檔案: ...
- 關鍵代碼: ...

## 預防措施
- 代碼審查: ...
- 自動化測試: ...
```

---

## 最終階段：Git Commit & Push

### Commit 訊息格式
```bash
<type>: <subject>

[optional body]

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
```

### Type 選項
| Type | 說明 | 範例 |
|------|------|------|
| `feat` | 新功能 | feat: 新增 Threads 發文功能 |
| `fix` | 修復 BUG | fix: 修復 UUID 格式錯誤 |
| `refactor` | 重構 | refactor: 優化權限檢查邏輯 |
| `security` | 安全修復 | security: 強化內部 API 驗證 |
| `perf` | 效能優化 | perf: 減少資料庫查詢次數 |

### Push 流程
```bash
git add <files>
git commit -m "<message>"
git push origin main
```

---

## 自動化觸發

### 使用方式
完成功能開發後，執行：
```
/complete-workflow
```

系統將自動執行：
1. 代碼審查 (review) - 識別所有問題
2. **代碼簡化與修正 (simplify) - 自動修正 🔴 高嚴重度問題**
3. 代碼簡化分析 - 優化代碼結構
4. 知識記錄 (knowledge) - 記錄修復過程
5. Git commit & push

### 執行邏輯
```
階段一 review → 發現問題 → 階段二自動修正 → 重新審查 → 通過後繼續
```

### 手動執行各階段
```
/review            # 只執行代碼審查
/complete-workflow stage2  # 只執行代碼簡化與修正
/knowledge record  # 只執行知識記錄
```

---

## 品質門檻

任何階段失敗都需要修復後才能進入下一階段：

| 階段 | 門檻 | 失敗處理 |
|------|------|----------|
| Review | 記錄所有問題 | 進入階段二修正 |
| Simplify | **🔴 高嚴重度問題：0 個**<br>評分 ≥7/10 | 繼續修正直到通過 |
| Knowledge | 記錄完整（含修正過程） | 補充記錄 |
| Git | 無 merge conflict | 解決衝突後推送 |

### 🔴 高嚴重度問題強制修正
階段二發現任何 🔴 高嚴重度問題時：
1. **自動修正**該問題
2. **重新執行 review** 驗證
3. 確認 🔴 問題數量 = 0 後才能進入階段三

---

## 進度追蹤

當前工作流狀態會在完成後顯示：

```
✅ 階段一：代碼審查 - 發現 3 個 🔴 問題 (6.5/10)
⚙️  階段二：代碼簡化與修正 - 修正中...
   ├─ ✅ 修正：資料庫連線洩漏 (worker.py:38-44)
   ├─ ✅ 修正：同步/異步混用 (worker.py:75-78)
   └─ ⏳ 修正：敏感資訊處理 (storage_service.py:20-21)
✅ 階段二：代碼簡化與修正 - 通過 (8.5/10) | 🔴 0 個
✅ 階段三：知識管理 - 已記錄 BUG-003, BUG-004
✅ 階段四：Git Push - commit abc1234
```
